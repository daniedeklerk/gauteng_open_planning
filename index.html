<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Planning Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SQL.js library for SQLite support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c5530;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .filters {
            padding: 30px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .filter-group select, .filter-group input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: #2c5530;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #2c5530;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a21;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .content {
            padding: 30px;
        }

        .milestone {
            margin-bottom: 40px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .milestone-header {
            padding: 20px 25px;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .milestone-header:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .milestone-toggle {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .milestone-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .milestone-content {
            background: white;
            padding: 25px;
            overflow: hidden;
            transition: all 0.3s ease;
            height: auto;
        }

        .milestone-content.collapsed {
            height: 0;
            padding: 0;
            opacity: 0;
        }

        .milestone-1 { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .milestone-2 { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .milestone-3 { background: linear-gradient(135deg, #45b7d1, #96c93d); }
        .milestone-4 { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .milestone-5 { background: linear-gradient(135deg, #4facfe, #00f2fe); }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .task {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #2c5530;
            transition: all 0.3s ease;
            align-items: flex-start;
        }

        .task:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .task.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .task.overdue {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        .task-assignees {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .task-assignee {
            background: #2c5530;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin: 2px;
        }

        .task-assignee .remove-tag {
            margin-left: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }

        .task-assignee .remove-tag:hover {
            opacity: 1;
            background: rgba(255,255,255,0.3);
        }

        .task-deadline {
            color: #e74c3c;
            font-weight: 500;
        }

        .assign-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .member-selector {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }

        .member-select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .add-member-btn, .remove-member-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .add-member-btn {
            background: #28a745;
            color: white;
        }

        .remove-member-btn {
            background: #dc3545;
            color: white;
        }

        .add-member-btn:hover {
            background: #218838;
        }

        .remove-member-btn:hover {
            background: #c82333;
        }

        .no-tasks {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .completion-modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .completion-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c5530;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            background-color: white;
            color: #333;
            z-index: 1003;
            position: relative;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #2c5530;
            box-shadow: 0 0 0 2px rgba(44, 85, 48, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .milestone-1 { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .milestone-2 { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .milestone-3 { background: linear-gradient(135deg, #45b7d1, #96c93d); }
        .milestone-4 { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .milestone-5 { background: linear-gradient(135deg, #4facfe, #00f2fe); }

        .section {
            margin-bottom: 30px;
        }
            
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 10px;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            #adminPassword {
                min-width: 0;
                width: 100%;
            }
            
            .filter-group div {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-group button {
                margin-top: 5px;
                width: 100%;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .task {
                grid-template-columns: auto 1fr;
                grid-template-areas:
                    "checkbox content"
                    "space assign";
                gap: 10px;
                padding: 12px;
            }
            
            .task-checkbox {
                grid-area: checkbox;
                align-self: center;
            }
            
            .task-content {
                grid-area: content;
            }
            
            .assign-section {
                grid-area: assign;
                width: 100%;
                margin-top: 10px;
            }
            
            .milestone-header {
                padding: 15px;
                font-size: 1rem;
            }
            
            .milestone-content {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.85rem;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
            
            .filters {
                padding: 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            .task-meta {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .floating-action {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .stats {
                grid-template-columns: 1fr 1fr;
                padding: 10px;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .member-selector {
                flex-direction: column;
                align-items: stretch;
            }
            
            .add-member-btn, .remove-member-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #2c5530;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .floating-action:hover {
            transform: scale(1.1);
            background: #1e3a21;
        }

        .completed-by {
            color: #28a745;
            font-style: italic;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Member Modal Styles */
        .member-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            pointer-events: auto;
        }

        .member-modal h3 {
            margin-bottom: 15px;
            color: #2c5530;
        }

        .member-modal select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
        }

        .member-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .member-modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .member-modal-buttons button:first-child {
            background: #2c5530;
            color: white;
        }

        .member-modal-buttons button:last-child {
            background: #6c757d;
            color: white;
        }

        /* System Message Modal Styles */
        .system-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            z-index: 1002;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .system-modal .message {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #333;
        }

        .system-modal .btn-ok {
            background: #2c5530;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .system-modal .btn-ok:hover {
            background: #1e3a21;
        }

        .version-tag {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }

        .task-notes {
            margin-top: 10px;
            padding-left: 20px;
        }

        .note-item {
            background: #f8f9fa;
            border-left: 3px solid #2c5530;
            padding: 8px 12px;
            margin: 5px 0;
            font-size: 0.9rem;
            border-radius: 4px;
            position: relative;
        }

        .note-actions {
            position: absolute;
            right: 8px;
            top: 8px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .note-item:hover .note-actions {
            opacity: 1;
        }

        .note-action-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 4px;
            font-size: 1.1rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .note-action-btn:hover {
            background: rgba(220,53,69,0.1);
        }

        .note-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }

        .add-note-btn {
            background: none;
            border: none;
            color: #2c5530;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 5px;
        }

        .add-note-btn:hover {
            background: #e9ecef;
            border-radius: 4px;
        }

        /* Note Modal Styles */
        .note-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
        }

        .note-modal textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏆 Tournament Planning Dashboard</h1>
            <p>Bronkhorstspruit Bowling Club | Men's Pairs (July 5-6) & Men's Singles (July 12, 2025)</p>
            <div class="version-tag" id="versionTag">Version 1.0</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingTasks">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="overdueTasks">0</div>
                <div class="stat-label">Overdue</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="adminToggle">Admin Mode</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <input type="password" id="adminPassword" placeholder="Enter admin password" style="flex: 1; min-width: 150px; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px;">
                        <button class="btn btn-primary" onclick="toggleAdminMode()" id="adminBtn">Enable Admin</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="memberFilter">Filter by Member</label>
                    <select id="memberFilter">
                        <option value="">All Members</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="milestoneFilter">Filter by Milestone</label>
                    <select id="milestoneFilter">
                        <option value="">All Milestones</option>
                        <option value="1">Urgent Preparation</option>
                        <option value="2">Greens & Facilities</option>
                        <option value="3">Catering Arrangements</option>
                        <option value="4">Competition Setup</option>
                        <option value="5">Final Preparations</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Filter by Status</label>
                    <select id="statusFilter">
                        <option value="">All Tasks</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="exportProgress()">📄 Export PDF</button>
                <button class="btn btn-secondary" onclick="clearFilters()">🔄 Clear Filters</button>
                <button class="btn btn-primary" onclick="markAllComplete()" ${!isAdminMode ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>✅ Mark Milestone Complete</button>
                <button class="btn btn-secondary" onclick="toggleAllMilestones(false)">🔽 Expand All</button>
                <button class="btn btn-secondary" onclick="toggleAllMilestones(true)">🔼 Collapse All</button>
            </div>
        </div>

        <div class="content" id="content">
            <!-- Content will be generated by JavaScript -->
        </div>
    </div>

    <!-- System Message Modal -->
    <div id="systemModal" class="system-modal">
        <div class="message"></div>
        <button class="btn-ok" onclick="closeSystemModal()">OK</button>
    </div>

    <!-- Completion Modal -->
    <div id="completionModal" class="completion-modal">
        <div class="completion-modal-content">
            <div class="modal-header">Task Completion</div>
            <p>Please enter your name to confirm task completion:</p>
            <input type="text" id="completionName" class="modal-input" placeholder="Enter your full name">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeCompletionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCompletion()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div id="memberModal" class="member-modal">
        <h3>Assign Member to Task</h3>
        <select id="memberSelect" class="member-select">
            <option value="">Select Member</option>
        </select>
        <div class="member-modal-buttons">
            <button onclick="confirmMemberSelection()">Add Member</button>
            <button onclick="closeMemberModal()">Cancel</button>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="modal-overlay"></div>

    <!-- Note Modal -->
    <div id="noteModal" class="note-modal">
        <h3>Add Note</h3>
        <textarea id="noteText" placeholder="Enter your note here..."></textarea>
        <div class="member-modal-buttons">
            <button onclick="confirmAddNote()">Add Note</button>
            <button onclick="closeNoteModal()">Cancel</button>
        </div>
    </div>

    <!-- System Confirmation Modal -->
    <div id="confirmationModal" class="system-modal">
        <div class="message"></div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button class="btn btn-primary" onclick="handleConfirmationResponse(true)">Yes</button>
            <button class="btn btn-secondary" onclick="handleConfirmationResponse(false)">No</button>
        </div>
    </div>

    <!-- Note Name Modal -->
    <div id="noteNameModal" class="completion-modal">
        <div class="completion-modal-content">
            <div class="modal-header">Enter Your Name</div>
            <input type="text" id="noteAuthorName" class="modal-input" placeholder="Enter your full name">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeNoteNameModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmNoteName()">Confirm</button>
            </div>
        </div>
    </div>

    <button class="floating-action" onclick="scrollToTop()" title="Back to Top">↑</button>

    <script>
        // Tournament planning data
        const milestones = [
            {
                id: 1,
                title: "URGENT PREPARATION",
                deadline: "June 20, 2025",
                sections: [
                    {
                        title: "Officials & Administration Setup",
                        tasks: [
                            "Appoint Tournament Official and send name/contact to ewagner@mweb.co.za",
                            "Arrange office/space for Tournament Official with computer and internet access",
                            "Recruit one Technical Official (Umpire) per green - send names to ewagner@mweb.co.za",
                            "Ensure Umpire has fully equipped kit (measuring tape, chalk, etc.)",
                            "Arrange markers for Singles sectional games",
                            "Test and prepare lightning detector with extra batteries",
                            "Check public liability insurance is current and valid",
                            "Prepare first aid kit (plasters, disinfectant, rub - NO medications)",
                            "Set up VIP parking area with clear signage"
                        ]
                    }
                ]
            },
            {
                id: 2,
                title: "GREENS & FACILITIES PREPARATION",
                deadline: "June 25, 2025",
                sections: [
                    {
                        title: "Green Maintenance",
                        tasks: [
                            "Ensure greens are Grade \"B\" standard (minimum 12 seconds speed)",
                            "Schedule daily green cutting for tournament dates",
                            "Mark greens for morning and afternoon play directions",
                            "Test green speed weekly leading up to tournament"
                        ]
                    },
                    {
                        title: "Facilities & Equipment",
                        tasks: [
                            "Arrange gazebos/umbrellas for spectator shade",
                            "Set up water canisters and refill schedule",
                            "Prepare clean flags for daily raising",
                            "Arrange security for parking area",
                            "Ensure bar facilities are operational",
                            "Establish dress code (club attire) signage"
                        ]
                    }
                ]
            },
            {
                id: 3,
                title: "CATERING ARRANGEMENTS",
                deadline: "June 28, 2025",
                sections: [
                    {
                        title: "Menu Planning & Setup",
                        tasks: [
                            "Create daily menus and display boards",
                            "Arrange table numbers and VIP/TO reserved seating",
                            "Prepare meal tickets for various options (R15-R70 range)",
                            "Set up multiple service points if expecting 50+ people per day",
                            "Arrange Saturday evening braai & entertainment (if desired)",
                            "Prepare meal claim forms for VIPs/markers",
                            "Contact Retha (treas.bgn@gmail.com) for reimbursement process",
                            "Budget for Tournament Official and Technical Official meals (club expense)"
                        ]
                    }
                ]
            },
            {
                id: 4,
                title: "COMPETITION SETUP",
                deadline: "July 1, 2025",
                sections: [
                    {
                        title: "Documentation & Systems",
                        tasks: [
                            "Print and display Conditions of Play prominently",
                            "Prepare declaration forms with all required sections",
                            "Set up computer access to Bowls Draw System (bowlsdraw.co.za)",
                            "Test internet connection and data bundle",
                            "Prepare scorecards for all matches"
                        ]
                    },
                    {
                        title: "Player Communication",
                        tasks: [
                            "Display Tournament Official's name and contact number",
                            "Post medical emergency numbers (doctor, dentist, emergency services)",
                            "Create player information boards with game times and details"
                        ]
                    }
                ]
            },
            {
                id: 5,
                title: "FINAL PREPARATIONS",
                deadline: "July 4, 2025",
                sections: [
                    {
                        title: "Last-Minute Checks",
                        tasks: [
                            "Verify no green fees required (covered in entry fees)",
                            "Test bell/siren system for time calls",
                            "Arrange sponsor banner display and return plan",
                            "Set up photo/video coordination with players",
                            "Prepare warm-up area allocation system"
                        ]
                    },
                    {
                        title: "Staff Briefing",
                        tasks: [
                            "Brief all volunteers on their roles and responsibilities",
                            "Review tournament schedule and timings",
                            "Explain emergency procedures",
                            "Assign backup personnel for key roles"
                        ]
                    }
                ]
            }
        ];

        // Available members
        const members = [
            "Archer, Marianne (76363)",
            "Blake, Patrick (76731)",
            "Dalgleish, Santie (59193)",
            "de Klerk, Elsabé (70568)",
            "Dreyer, Albert (32176)",
            "Dreyer, Yvonne (72024)",
            "du Plessis, Manie (57961)",
            "Engelbrecht, Manie (58268)",
            "Fourie, Johan (2860)",
            "Kendall, Elizabeth (63705)",
            "Le Roux, Christie (2871)",
            "le Roux, Johan (2873)",
            "Liebenberg, Jan (69811)",
            "Liebenberg, Norene (34067)",
            "Moolman, Jurgens (76328)",
            "Moolman, Marlien (76332)",
            "Muhlhauser, Dee (13708)",
            "O'Connel, John (64223)",
            "Pieters, Jannie (78529)",
            "Prinsloo, Martin (75579)",
            "Prinsloo, Rina (56571)",
            "Seymour, Kobus (77924)",
            "Steyl, Bruyn (69071)",
            "Swart, Blackie (68017)",
            "Swart, Reinette (71354)",
            "Van der Merwe, Rosemarie (73102)",
            "Van Niekerk, Petru (76569)",
            "Van Wyk, Adri (64354)",
            "Vaughan, Anna-Marie (3379)",
            "Vaughan, Bob (3378)",
            "De kock, Marius (10367)",
            "Dippenaar, Shani (76348)",
            "Mc Cann , Neil (72030)",
            "Gouws, Nanette (79193)",
            "Gouws, Riaan (79194)",
            "Maree, Yolanda (74933)",
            "Van Rensburg, Christien (67030)",
            "Van Rensburg, Toon (67545)",
            "Venter, Elaine (79265)",
            "Venter, Christina (79267)",
            "Fivaz, Regardt (80060)",
            "van Zyl, Christo (80265)",
            "de Klerk, Danie (70567)",
            "Grobler, Jannie (80686)",
            "Smith, Cindy (80726)",
            "Taljaard, Bettie (80725)"
        ];

        let db;
        let isAdminMode = false;
        let currentTaskId = null;
        let useFallbackStorage = true;

        // Fallback storage objects
        let taskAssignments = {}; // taskId: [member1, member2, ...]
        let taskCompletions = {}; // taskId: {isCompleted, completedBy, completedAt}
        let collapsedMilestones = {}; // milestoneId: boolean
        let taskNotes = {};
        let currentNoteTaskId = null;

        // Admin password
        const adminPassword = "bowls2025danie";

        // Add these variables at the start of your script
        let confirmationCallback = null;
        let confirmationCheckbox = null;

        // Add these variables
        let pendingNoteText = null;
        let pendingNoteAction = null;

        // Initialize database or fallback storage
        async function initDatabase() {
            try {
                // Try to load SQLite if available
                if (typeof initSqlJs !== 'undefined') {
                    const SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                    });
                    
                    // Try to load existing database from localStorage
                    let dbData = localStorage.getItem('tournamentPlannerDB');
                    if (dbData) {
                        try {
                            // Convert base64 string to Uint8Array
                            const binaryString = window.atob(dbData);
                            const len = binaryString.length;
                            const bytes = new Uint8Array(len);
                            for (let i = 0; i < len; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }
                            db = new SQL.Database(bytes);
                            console.log('Loaded existing database from localStorage');
                        } catch (e) {
                            console.error('Error loading database from localStorage:', e);
                            db = new SQL.Database(); // Create new if loading fails
                        }
                    } else {
                        db = new SQL.Database(); // Create new if none exists
                    }
                    
                    useFallbackStorage = false;
                    
                    // Create tables
                    db.run(`
                        CREATE TABLE IF NOT EXISTS task_assignments (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            task_id TEXT,
                            member_name TEXT,
                            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                        );
                    `);
                    
                    db.run(`
                        CREATE TABLE IF NOT EXISTS task_completions (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            task_id TEXT UNIQUE,
                            completed_by TEXT,
                            completed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            is_completed BOOLEAN DEFAULT TRUE
                        );
                    `);
                    
                    db.run(`
                        CREATE TABLE IF NOT EXISTS collapsed_milestones (
                            milestone_id INTEGER PRIMARY KEY,
                            is_collapsed BOOLEAN DEFAULT FALSE
                        );
                    `);
                    
                    // Add notes table
                    db.run(`
                        CREATE TABLE IF NOT EXISTS task_notes (
                            id TEXT PRIMARY KEY,
                            task_id TEXT,
                            note_text TEXT,
                            added_by TEXT,
                            added_at DATETIME DEFAULT CURRENT_TIMESTAMP
                        );
                    `);
                    
                    // Migrate data from fallback storage if needed
                    migrateFromFallbackIfNeeded();
                    
                    // Set up auto-save mechanism
                    window.setInterval(saveDatabase, 30000); // Save every 30 seconds
                    
                    console.log('SQLite database initialized successfully');
                } else {
                    throw new Error('SQLite not available');
                }
            } catch (error) {
                console.error('Error initializing SQLite:', error);
                console.log('Using fallback in-memory storage');
                useFallbackStorage = true;
                loadFromFallbackStorage();
            }
        }

        function loadFromFallbackStorage() {
            try {
                const assignments = sessionStorage.getItem('taskAssignments');
                const completions = sessionStorage.getItem('taskCompletions');
                const collapsed = sessionStorage.getItem('collapsedMilestones');
                const notes = sessionStorage.getItem('taskNotes');
                
                if (assignments) taskAssignments = JSON.parse(assignments);
                if (completions) taskCompletions = JSON.parse(completions);
                if (collapsed) collapsedMilestones = JSON.parse(collapsed);
                if (notes) taskNotes = JSON.parse(notes);
            } catch (e) {
                // Start with empty data if parsing fails
                taskAssignments = {};
                taskCompletions = {};
                collapsedMilestones = {};
                taskNotes = {};
            }
        }

        function saveToFallbackStorage() {
            try {
                sessionStorage.setItem('taskAssignments', JSON.stringify(taskAssignments));
                sessionStorage.setItem('taskCompletions', JSON.stringify(taskCompletions));
                sessionStorage.setItem('collapsedMilestones', JSON.stringify(collapsedMilestones));
                sessionStorage.setItem('taskNotes', JSON.stringify(taskNotes));
            } catch (e) {
                console.log('Session storage not available');
            }
        }

        function getTaskAssignments(taskId) {
            if (useFallbackStorage) {
                return taskAssignments[taskId] || [];
            } else {
                const stmt = db.prepare("SELECT member_name FROM task_assignments WHERE task_id = ?");
                const assignments = [];
                
                try {
                    stmt.bind([taskId]);
                    while (stmt.step()) {
                        const row = stmt.getAsObject();
                        assignments.push(row.member_name);
                    }
                } finally {
                    stmt.free();
                }
                
                return assignments;
            }
        }

        function addTaskAssignment(taskId, memberName) {
            if (!memberName || memberName === 'Select Member') return;
            
            if (useFallbackStorage) {
                if (!taskAssignments[taskId]) {
                    taskAssignments[taskId] = [];
                }
                if (!taskAssignments[taskId].includes(memberName)) {
                    taskAssignments[taskId].push(memberName);
                    saveToFallbackStorage();
                }
            } else {
                try {
                    // Check if assignment already exists
                    const stmt = db.prepare("SELECT COUNT(*) as count FROM task_assignments WHERE task_id = ? AND member_name = ?");
                    stmt.bind([taskId, memberName]);
                    
                    if (stmt.step()) {
                        const row = stmt.getAsObject();
                        if (row.count === 0) {
                            db.run("INSERT INTO task_assignments (task_id, member_name) VALUES (?, ?)", [taskId, memberName]);
                            saveDatabase(); // Save after modification
                        }
                    }
                    stmt.free();
                } catch (error) {
                    console.error('Error adding task assignment:', error);
                    // Fallback to in-memory storage if database operation fails
                    if (!taskAssignments[taskId]) {
                        taskAssignments[taskId] = [];
                    }
                    if (!taskAssignments[taskId].includes(memberName)) {
                        taskAssignments[taskId].push(memberName);
                        saveToFallbackStorage();
                    }
                }
            }
        }

        function removeTaskAssignment(taskId, memberName) {
            if (!isAdminMode) return;
            
            if (useFallbackStorage) {
                if (taskAssignments[taskId]) {
                    taskAssignments[taskId] = taskAssignments[taskId].filter(name => name !== memberName);
                    if (taskAssignments[taskId].length === 0) {
                        delete taskAssignments[taskId];
                    }
                    saveToFallbackStorage();
                }
            } else {
                try {
                    db.run("DELETE FROM task_assignments WHERE task_id = ? AND member_name = ?", [taskId, memberName]);
                    saveDatabase();
                } catch (error) {
                    console.error('Error removing task assignment:', error);
                    // Fallback to in-memory storage if database operation fails
                    if (taskAssignments[taskId]) {
                        taskAssignments[taskId] = taskAssignments[taskId].filter(name => name !== memberName);
                        if (taskAssignments[taskId].length === 0) {
                            delete taskAssignments[taskId];
                        }
                        saveToFallbackStorage();
                    }
                }
            }
        }

        function getTaskCompletion(taskId) {
            if (useFallbackStorage) {
                const completion = taskCompletions[taskId];
                return completion || { isCompleted: false, completedBy: null, completedAt: null };
            } else {
                try {
                    const stmt = db.prepare("SELECT * FROM task_completions WHERE task_id = ?");
                    stmt.bind([taskId]);
                    
                    if (stmt.step()) {
                        const row = stmt.getAsObject();
                        stmt.free();
                        return {
                            isCompleted: Boolean(row.is_completed),
                            completedBy: row.completed_by,
                            completedAt: row.completed_at
                        };
                    }
                    stmt.free();
                    return { isCompleted: false, completedBy: null, completedAt: null };
                } catch (error) {
                    console.error('Error getting task completion:', error);
                    return { isCompleted: false, completedBy: null, completedAt: null };
                }
            }
        }

        function setTaskCompletion(taskId, isCompleted, completedBy = null) {
            const timestamp = new Date().toISOString();
            
            if (useFallbackStorage) {
                if (isCompleted) {
                    taskCompletions[taskId] = {
                        isCompleted: true,
                        completedBy: completedBy,
                        completedAt: timestamp
                    };
                } else {
                    delete taskCompletions[taskId];
                }
                saveToFallbackStorage();
            } else {
                try {
                    if (isCompleted) {
                        db.run(`
                            INSERT OR REPLACE INTO task_completions 
                            (task_id, completed_by, completed_at, is_completed) 
                            VALUES (?, ?, ?, ?)
                        `, [taskId, completedBy, timestamp, 1]);
                    } else {
                        db.run("DELETE FROM task_completions WHERE task_id = ?", [taskId]);
                    }
                    saveDatabase(); // Save after modification
                } catch (error) {
                    console.error('Error setting task completion:', error);
                    // Fallback to in-memory storage if database operation fails
                    if (isCompleted) {
                        taskCompletions[taskId] = {
                            isCompleted: true,
                            completedBy: completedBy,
                            completedAt: timestamp
                        };
                    } else {
                        delete taskCompletions[taskId];
                    }
                    saveToFallbackStorage();
                }
            }
        }

        function getMilestoneCollapsed(milestoneId) {
            if (useFallbackStorage) {
                return collapsedMilestones[milestoneId] || false;
            } else {
                const stmt = db.prepare("SELECT is_collapsed FROM collapsed_milestones WHERE milestone_id = ?");
                stmt.bind({$milestoneId: milestoneId});
                
                if (stmt.step()) {
                    const row = stmt.getAsObject();
                    stmt.free();
                    return row.is_collapsed === 1;
                }
                stmt.free();
                return false;
            }
        }

        function setMilestoneCollapsed(milestoneId, isCollapsed) {
            if (useFallbackStorage) {
                collapsedMilestones[milestoneId] = isCollapsed;
                saveToFallbackStorage();
            } else {
                db.run(`
                    INSERT OR REPLACE INTO collapsed_milestones (milestone_id, is_collapsed) 
                    VALUES (?, ?)
                `, [milestoneId, isCollapsed ? 1 : 0]);
                saveDatabase(); // Save after modification
            }
        }

        function getTaskNotes(taskId) {
            if (useFallbackStorage) {
                return taskNotes[taskId] || [];
            } else {
                try {
                    const stmt = db.prepare("SELECT * FROM task_notes WHERE task_id = ? ORDER BY added_at DESC");
                    stmt.bind([taskId]);
                    
                    const notes = [];
                    while (stmt.step()) {
                        const row = stmt.getAsObject();
                        notes.push({
                            id: row.id,
                            text: row.note_text,
                            addedBy: row.added_by,
                            addedAt: row.added_at
                        });
                    }
                    stmt.free();
                    return notes;
                } catch (error) {
                    console.error('Error getting task notes:', error);
                    return [];
                }
            }
        }

        function addTaskNote(taskId, noteText, addedBy) {
            const timestamp = new Date().toISOString();
            const noteId = Date.now().toString(); // Simple unique ID
            
            if (useFallbackStorage) {
                if (!taskNotes[taskId]) {
                    taskNotes[taskId] = [];
                }
                taskNotes[taskId].unshift({
                    id: noteId,
                    text: noteText,
                    addedBy: addedBy,
                    addedAt: timestamp
                });
                saveToFallbackStorage();
            } else {
                try {
                    const stmt = db.prepare(`
                        INSERT INTO task_notes (id, task_id, note_text, added_by, added_at)
                        VALUES (?, ?, ?, ?, ?)
                    `);
                    stmt.run([noteId, taskId, noteText, addedBy, timestamp]);
                    stmt.free();
                    saveDatabase();
                } catch (error) {
                    console.error('Error adding task note:', error);
                    showSystemMessage('Error adding note. Please try again.');
                    return;
                }
            }
        }

        function showAddNoteModal(taskId) {
            currentNoteTaskId = taskId;
            const modal = document.getElementById('noteModal');
            const overlay = document.getElementById('modalOverlay');
            const noteText = document.getElementById('noteText');
            
            // Close any other open modals first
            closeAllModals();
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
            noteText.value = '';
            noteText.focus();
        }

        function closeAllModals() {
            const modals = [
                'noteModal',
                'noteNameModal',
                'completionModal',
                'confirmationModal',
                'systemModal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function confirmAddNote() {
            const noteText = document.getElementById('noteText').value.trim();
            
            if (!noteText) {
                showSystemMessage('Please enter a note.');
                return;
            }
            
            // Store the note text and show name modal
            pendingNoteText = noteText;
            
            // Close note modal and show name modal
            const noteModal = document.getElementById('noteModal');
            noteModal.style.display = 'none';
            
            const nameModal = document.getElementById('noteNameModal');
            const nameInput = document.getElementById('noteAuthorName');
            nameModal.style.display = 'block';
            nameInput.value = '';
            nameInput.focus();
        }

        function closeNoteModal() {
            const modal = document.getElementById('noteModal');
            const overlay = document.getElementById('modalOverlay');
            modal.style.display = 'none';
            if (!document.getElementById('noteNameModal').style.display === 'block') {
                overlay.style.display = 'none';
            }
            document.getElementById('noteText').value = '';
            currentNoteTaskId = null;
        }

        function showNoteNameModal(noteText, action) {
            pendingNoteText = noteText;
            pendingNoteAction = action;
            const modal = document.getElementById('noteNameModal');
            const overlay = document.getElementById('modalOverlay');
            const nameInput = document.getElementById('noteAuthorName');
            
            modal.style.display = 'block';
            overlay.style.display = 'block';
            nameInput.value = '';
            nameInput.focus();
        }

        function closeNoteNameModal() {
            const modal = document.getElementById('noteNameModal');
            const overlay = document.getElementById('modalOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
            document.getElementById('noteAuthorName').value = '';
            pendingNoteText = null;
            pendingNoteAction = null;
        }

        function confirmNoteName() {
            const authorName = document.getElementById('noteAuthorName').value.trim();
            
            if (!authorName) {
                showSystemMessage('Please enter your name.');
                return;
            }
            
            if (pendingNoteText && currentNoteTaskId) {
                addTaskNote(currentNoteTaskId, pendingNoteText, authorName);
                closeAllModals();
                renderTasks();
                showSystemMessage('Note added successfully!');
                
                // Clear the pending data
                pendingNoteText = null;
                currentNoteTaskId = null;
            }
        }

        function editTaskNote(taskId, noteId, newText, editedBy) {
            const timestamp = new Date().toISOString();
            
            if (useFallbackStorage) {
                if (taskNotes[taskId]) {
                    const noteIndex = taskNotes[taskId].findIndex(n => n.id === noteId);
                    if (noteIndex !== -1) {
                        taskNotes[taskId][noteIndex] = {
                            ...taskNotes[taskId][noteIndex],
                            text: newText,
                            editedBy,
                            editedAt: timestamp
                        };
                    }
                }
                saveToFallbackStorage();
            } else {
                try {
                    db.run(`
                        UPDATE task_notes 
                        SET note_text = ?, edited_by = ?, edited_at = ?
                        WHERE task_id = ? AND id = ?
                    `, [newText, editedBy, timestamp, taskId, noteId]);
                    saveDatabase();
                } catch (error) {
                    console.error('Error editing task note:', error);
                }
            }
        }

        function deleteTaskNote(taskId, noteId) {
            if (!isAdminMode) {
                showSystemMessage('Only administrators can delete notes.');
                return;
            }

            showConfirmationDialog(
                "Are you sure you want to delete this note?",
                null,
                async (confirmed) => {
                    if (confirmed) {
                        let deleted = false;
                        
                        if (useFallbackStorage) {
                            if (taskNotes[taskId]) {
                                const initialLength = taskNotes[taskId].length;
                                taskNotes[taskId] = taskNotes[taskId].filter(n => n.id !== noteId);
                                deleted = taskNotes[taskId].length < initialLength;
                                
                                if (taskNotes[taskId].length === 0) {
                                    delete taskNotes[taskId];
                                }
                                saveToFallbackStorage();
                            }
                        } else {
                            try {
                                // Execute the delete statement directly
                                db.exec(`DELETE FROM task_notes WHERE id = '${noteId}'`);
                                deleted = true;
                                saveDatabase();
                            } catch (error) {
                                console.error('Error deleting task note:', error);
                                showSystemMessage('Error deleting note. Please try again.');
                                return;
                            }
                        }
                        
                        if (deleted) {
                            // Close all modals before showing success message
                            closeAllModals();
                            // Wait a brief moment before re-rendering and showing message
                            await new Promise(resolve => setTimeout(resolve, 100));
                            renderTasks();
                            showSystemMessage('Note deleted successfully!');
                        }
                    }
                }
            );
        }

        // Save database to localStorage
        function saveDatabase() {
            if (!useFallbackStorage && db) {
                try {
                    const data = db.export();
                    const arr = new Uint8Array(data);
                    let binary = '';
                    for (let i = 0; i < arr.length; i++) {
                        binary += String.fromCharCode(arr[i]);
                    }
                    const base64 = window.btoa(binary);
                    localStorage.setItem('tournamentPlannerDB', base64);
                    console.log('Database saved to localStorage');
                } catch (e) {
                    console.error('Error saving database to localStorage:', e);
                }
            }
        }
        
        // Migrate data from fallback storage to SQLite if needed
        function migrateFromFallbackIfNeeded() {
            try {
                const assignments = sessionStorage.getItem('taskAssignments');
                const completions = sessionStorage.getItem('taskCompletions');
                const collapsed = sessionStorage.getItem('collapsedMilestones');
                const notes = sessionStorage.getItem('taskNotes');
                
                if (assignments) {
                    const assignData = JSON.parse(assignments);
                    for (const taskId in assignData) {
                        assignData[taskId].forEach(member => {
                            db.run("INSERT OR IGNORE INTO task_assignments (task_id, member_name) VALUES (?, ?)", [taskId, member]);
                        });
                    }
                }
                
                if (completions) {
                    const completionData = JSON.parse(completions);
                    for (const taskId in completionData) {
                        const data = completionData[taskId];
                        db.run(
                            "INSERT OR REPLACE INTO task_completions (task_id, completed_by, is_completed) VALUES (?, ?, ?)",
                            [taskId, data.completedBy, data.isCompleted ? 1 : 0]
                        );
                    }
                }
                
                if (collapsed) {
                    const collapsedData = JSON.parse(collapsed);
                    for (const milestoneId in collapsedData) {
                        db.run(
                            "INSERT OR REPLACE INTO collapsed_milestones (milestone_id, is_collapsed) VALUES (?, ?)",
                            [milestoneId, collapsedData[milestoneId] ? 1 : 0]
                        );
                    }
                }
                
                if (notes) {
                    const noteData = JSON.parse(notes);
                    for (const taskId in noteData) {
                        noteData[taskId].forEach(note => {
                            db.run(
                                "INSERT INTO task_notes (task_id, note_text, added_by) VALUES (?, ?, ?)",
                                [taskId, note.text, note.addedBy]
                            );
                        });
                    }
                }
                
                // Clear session storage after migration
                sessionStorage.removeItem('taskAssignments');
                sessionStorage.removeItem('taskCompletions');
                sessionStorage.removeItem('collapsedMilestones');
                sessionStorage.removeItem('taskNotes');
            } catch (e) {
                console.error('Error migrating data from fallback storage:', e);
            }
        }
        
        // Database persistence functions already defined
        
        // Initialize the application
        async function init() {
            try {
                await Promise.all([
                    initDatabase(),
                    updateVersionTag()
                ]);
                populateMemberFilter();
                renderTasks();
                updateStats();
            } catch (error) {
                console.error('Initialization error:', error);
            }
            
            // Set up event listener to save database before page unload
            window.addEventListener('beforeunload', saveDatabase);
        }

        function populateMemberFilter() {
            const memberFilter = document.getElementById('memberFilter');
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                memberFilter.appendChild(option);
            });
        }

        function renderTasks() {
            const content = document.getElementById('content');
            const memberFilter = document.getElementById('memberFilter').value;
            const milestoneFilter = document.getElementById('milestoneFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            content.innerHTML = '';

            let hasVisibleTasks = false;

            milestones.forEach(milestone => {
                if (milestoneFilter && milestone.id.toString() !== milestoneFilter) return;

                const milestoneDiv = document.createElement('div');
                milestoneDiv.className = `milestone milestone-${milestone.id}`;

                const milestoneHeader = document.createElement('div');
                milestoneHeader.className = 'milestone-header';
                milestoneHeader.onclick = () => toggleMilestone(milestone.id);
                
                const isCollapsed = getMilestoneCollapsed(milestone.id);
                milestoneHeader.innerHTML = `
                    <span><strong>${milestone.title}</strong> - Due: ${milestone.deadline}</span>
                    <span class="milestone-toggle ${isCollapsed ? 'collapsed' : ''}">▼</span>
                `;

                const milestoneContent = document.createElement('div');
                milestoneContent.className = `milestone-content ${isCollapsed ? 'collapsed' : 'expanded'}`;

                let milestoneHasTasks = false;

                milestone.sections.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section';

                    const sectionTitle = document.createElement('div');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = section.title;

                    let sectionHasTasks = false;

                    section.tasks.forEach((task, taskIndex) => {
                        const taskId = `${milestone.id}-${section.title}-${taskIndex}`;
                        const assignedMembers = getTaskAssignments(taskId);
                        const completion = getTaskCompletion(taskId);
                        const isCompleted = completion.isCompleted;
                        const isOverdue = !isCompleted && new Date() > new Date(milestone.deadline);

                        // Apply filters
                        if (memberFilter && !assignedMembers.includes(memberFilter)) return;
                        if (statusFilter === 'completed' && !isCompleted) return;
                        if (statusFilter === 'pending' && isCompleted) return;
                        if (statusFilter === 'overdue' && !isOverdue) return;

                        const taskDiv = document.createElement('div');
                        taskDiv.className = `task ${isCompleted ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}`;

                        // Create checkbox part
                        const checkboxPart = document.createElement('input');
                        checkboxPart.type = 'checkbox';
                        checkboxPart.className = 'task-checkbox';
                        checkboxPart.checked = isCompleted;
                        checkboxPart.addEventListener('change', () => toggleTask(taskId));

                        // Create content part
                        const contentPart = document.createElement('div');
                        contentPart.className = 'task-content';
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'task-title';
                        titleDiv.textContent = task;
                        contentPart.appendChild(titleDiv);
                        
                        if (completion.completedBy && isCompleted) {
                            const completedByDiv = document.createElement('div');
                            completedByDiv.className = 'completed-by';
                            completedByDiv.innerHTML = `✓ Completed by: ${completion.completedBy}`;
                            contentPart.appendChild(completedByDiv);
                        }
                        
                        const metaDiv = document.createElement('div');
                        metaDiv.className = 'task-meta';
                        metaDiv.innerHTML = `<span class="task-deadline">Due: ${milestone.deadline}</span>`;
                        contentPart.appendChild(metaDiv);

                        // Create assignees part
                        const assigneesDiv = document.createElement('div');
                        assigneesDiv.className = 'task-assignees';
                        
                        if (assignedMembers && assignedMembers.length > 0) {
                            assignedMembers.forEach((member, index) => {
                                if (member && member.trim() !== '') {
                                    const assigneeTag = document.createElement('span');
                                    assigneeTag.className = 'task-assignee';
                                    
                                    // Add member name
                                    const memberText = document.createElement('span');
                                    memberText.textContent = member;
                                    assigneeTag.appendChild(memberText);
                                    
                                    // Add remove button if in admin mode
                                    if (isAdminMode) {
                                        const removeBtn = document.createElement('span');
                                        removeBtn.className = 'remove-tag';
                                        removeBtn.innerHTML = '×';
                                        removeBtn.title = 'Remove member';
                                        removeBtn.onclick = (e) => {
                                            e.stopPropagation();
                                            showConfirmationDialog(
                                                `Remove ${member} from this task?`,
                                                null,
                                                (confirmed) => {
                                                    if (confirmed) {
                                                        removeTaskAssignment(taskId, member);
                                                        renderTasks();
                                                        updateStats();
                                                    }
                                                }
                                            );
                                        };
                                        assigneeTag.appendChild(removeBtn);
                                    }
                                    
                                    assigneesDiv.appendChild(assigneeTag);
                                }
                            });
                        }
                        contentPart.appendChild(assigneesDiv);

                        // Create notes section
                        const notesDiv = document.createElement('div');
                        notesDiv.className = 'task-notes';
                        
                        // Add the notes button
                        const addNoteBtn = document.createElement('button');
                        addNoteBtn.className = 'add-note-btn';
                        addNoteBtn.innerHTML = '<span style="font-size: 1.2em;">+</span> Add Note';
                        addNoteBtn.onclick = (e) => {
                            e.stopPropagation();
                            showAddNoteModal(taskId);
                        };
                        notesDiv.appendChild(addNoteBtn);
                        
                        // Add existing notes
                        const notes = getTaskNotes(taskId);
                        if (notes && notes.length > 0) {
                            notes.forEach(note => {
                                const noteDiv = document.createElement('div');
                                noteDiv.className = 'note-item';
                                const date = new Date(note.addedAt).toLocaleString();
                                
                                // Create note content
                                const noteContent = document.createElement('div');
                                noteContent.style.whiteSpace = 'pre-wrap';
                                noteContent.style.paddingRight = '40px'; // Make room for delete button
                                noteContent.textContent = note.text;
                                
                                // Create note metadata
                                const noteMeta = document.createElement('div');
                                noteMeta.className = 'note-meta';
                                noteMeta.textContent = `Added by ${note.addedBy} on ${date}`;
                                
                                // Create delete button for admin
                                if (isAdminMode) {
                                    const actionDiv = document.createElement('div');
                                    actionDiv.className = 'note-actions';
                                    
                                    // Delete button
                                    const deleteBtn = document.createElement('button');
                                    deleteBtn.className = 'note-action-btn';
                                    deleteBtn.innerHTML = '×';
                                    deleteBtn.title = 'Delete Note';
                                    deleteBtn.onclick = (e) => {
                                        e.stopPropagation();
                                        deleteTaskNote(taskId, note.id);
                                    };
                                    
                                    actionDiv.appendChild(deleteBtn);
                                    noteDiv.appendChild(actionDiv);
                                }
                                
                                noteDiv.appendChild(noteContent);
                                noteDiv.appendChild(noteMeta);
                                notesDiv.appendChild(noteDiv);
                            });
                        }
                        
                        contentPart.appendChild(notesDiv);

                        // Create assignment section
                        const assignSectionDiv = document.createElement('div');
                        assignSectionDiv.className = 'assign-section';
                        
                        if (isAdminMode) {
                            const addButton = document.createElement('button');
                            addButton.className = 'add-member-btn';
                            addButton.textContent = '+ Add Member';
                            addButton.onclick = (e) => {
                                e.stopPropagation();
                                addAssignment(taskId);
                            };
                            assignSectionDiv.appendChild(addButton);
                        } else {
                            assignSectionDiv.style.opacity = '0.5';
                            assignSectionDiv.innerHTML = `
                                <div style="font-size: 0.8rem; color: #666; text-align: center;">
                                    Admin mode required<br>for assignments
                                </div>
                            `;
                        }

                        // Append all parts to the task div
                        taskDiv.appendChild(checkboxPart);
                        taskDiv.appendChild(contentPart);
                        taskDiv.appendChild(assignSectionDiv);

                        sectionDiv.appendChild(taskDiv);
                        sectionHasTasks = true;
                        milestoneHasTasks = true;
                        hasVisibleTasks = true;
                    });

                    if (sectionHasTasks) {
                        sectionDiv.insertBefore(sectionTitle, sectionDiv.firstChild);
                        milestoneContent.appendChild(sectionDiv);
                    }
                });

                if (milestoneHasTasks) {
                    milestoneDiv.appendChild(milestoneHeader);
                    milestoneDiv.appendChild(milestoneContent);
                    content.appendChild(milestoneDiv);
                }
            });

            if (!hasVisibleTasks) {
                content.innerHTML = '<div class="no-tasks">No tasks match your current filters.</div>';
            }
        }

        // Shared variable for task assignment
        let selectedTaskId = null;

        function addAssignment(taskId) {
            if (!isAdminMode) {
                showSystemMessage('Only admin can assign tasks. Please enable admin mode first.');
                return;
            }
            
            selectedTaskId = taskId;
            
            // Populate member select dropdown
            const memberSelect = document.getElementById('memberSelect');
            memberSelect.innerHTML = '<option value="">Select Member</option>';
            
            // Get current assignments to filter out already assigned members
            const currentAssignments = getTaskAssignments(taskId);
            
            members.forEach(member => {
                // Only add members that aren't already assigned
                if (!currentAssignments.includes(member)) {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    memberSelect.appendChild(option);
                }
            });
            
            // Show the modal
            const memberModal = document.getElementById('memberModal');
            const modalOverlay = document.getElementById('modalOverlay');
            memberModal.style.display = 'block';
            modalOverlay.style.display = 'block';
            
            // Focus the select element
            memberSelect.focus();
        }

        function updateAssignment(taskId, index, newMember) {
            if (!isAdminMode) return;
            
            const currentAssignments = getTaskAssignments(taskId);
            const oldMember = currentAssignments[index];
            
            if (oldMember) {
                removeTaskAssignment(taskId, oldMember);
            }
            
            if (newMember && newMember !== '') {
                addTaskAssignment(taskId, newMember);
                renderTasks();
                updateStats();
            }
        }

        function removeAssignment(taskId, index) {
            if (!isAdminMode) return;
            
            const currentAssignments = getTaskAssignments(taskId);
            const memberToRemove = currentAssignments[index];
            
            if (memberToRemove) {
                removeTaskAssignment(taskId, memberToRemove);
                renderTasks();
                updateStats();
            }
        }

        function closeMemberModal() {
            const memberModal = document.getElementById('memberModal');
            const modalOverlay = document.getElementById('modalOverlay');
            memberModal.style.display = 'none';
            modalOverlay.style.display = 'none';
            selectedTaskId = null;
        }

        function confirmMemberSelection() {
            const memberSelect = document.getElementById('memberSelect');
            const selectedMember = memberSelect.value;
            
            if (selectedMember && selectedTaskId) {
                console.log('Adding member:', selectedMember, 'to task:', selectedTaskId);
                
                // Add the new member assignment
                addTaskAssignment(selectedTaskId, selectedMember);
                
                // Log current assignments
                const currentAssignments = getTaskAssignments(selectedTaskId);
                console.log('Current assignments for task:', selectedTaskId, currentAssignments);
                
                // Clear the selection
                memberSelect.value = '';
                
                // Update the member dropdown to remove the selected member
                const options = Array.from(memberSelect.options);
                
                // Remove all options except the first one (placeholder)
                while (memberSelect.options.length > 1) {
                    memberSelect.remove(1);
                }
                
                // Re-add available members
                members.forEach(member => {
                    if (!currentAssignments.includes(member)) {
                        const option = document.createElement('option');
                        option.value = member;
                        option.textContent = member;
                        memberSelect.appendChild(option);
                    }
                });
                
                // If no more members available, close the modal
                if (memberSelect.options.length === 1) {
                    closeMemberModal();
                }
                
                // Update the UI
                renderTasks();
                updateStats();
            } else {
                showSystemMessage('Please select a member');
            }
        }

        function toggleMilestone(milestoneId) {
            const milestone = document.querySelector(`.milestone-${milestoneId}`);
            if (!milestone) return;
            
            const toggle = milestone.querySelector('.milestone-toggle');
            const content = milestone.querySelector('.milestone-content');
            if (!toggle || !content) return;
            
            const isCollapsed = content.classList.contains('collapsed');
            
            // Update the database/storage
            setMilestoneCollapsed(milestoneId, !isCollapsed);
            
            // Update the UI
            if (isCollapsed) {
                // Expanding
                toggle.classList.remove('collapsed');
                content.classList.remove('collapsed');
            } else {
                // Collapsing
                toggle.classList.add('collapsed');
                content.classList.add('collapsed');
            }
        }

        function toggleAllMilestones(collapse = false) {
            milestones.forEach(milestone => {
                const milestoneElement = document.querySelector(`.milestone-${milestone.id}`);
                if (!milestoneElement) return;
                
                const toggle = milestoneElement.querySelector('.milestone-toggle');
                const content = milestoneElement.querySelector('.milestone-content');
                if (!toggle || !content) return;
                
                // Update the database/storage
                setMilestoneCollapsed(milestone.id, collapse);
                
                // Update the UI
                if (collapse) {
                    toggle.classList.add('collapsed');
                    content.classList.add('collapsed');
                } else {
                    toggle.classList.remove('collapsed');
                    content.classList.remove('collapsed');
                }
            });
        }

        function toggleTask(taskId) {
            const task = document.querySelector(`.task-${taskId}`);
            if (!task) return;
            
            const checkbox = task.querySelector('.task-checkbox');
            const content = task.querySelector('.task-content');
            const assignSection = task.querySelector('.assign-section');
            
            // Toggle the state
            const newCompletedState = !checkbox.checked;
            
            // Update the database/storage
            setTaskCompletion(taskId, newCompletedState);
            
            // Update the UI
            if (newCompletedState) {
                checkbox.checked = true;
                content.classList.add('completed');
                assignSection.style.opacity = '0.5';
            } else {
                checkbox.checked = false;
                content.classList.remove('completed');
                assignSection.style.opacity = '1';
            }
        }

        function clearFilters() {
            document.getElementById('memberFilter').value = '';
            document.getElementById('milestoneFilter').value = '';
            document.getElementById('statusFilter').value = '';
            renderTasks();
        }

        function exportProgress() {
            // First expand all milestones for the PDF
            toggleAllMilestones(false);
            
            // Create a clone of the container for PDF generation
            const container = document.querySelector('.container');
            const clone = container.cloneNode(true);
            
            // Remove buttons and admin sections from the clone
            clone.querySelectorAll('.button-group, .filters, .floating-action').forEach(el => el.remove());
            clone.querySelectorAll('.add-member-btn, .remove-tag, .add-note-btn').forEach(el => el.remove());
            
            // Add current date to the header
            const dateDiv = document.createElement('div');
            dateDiv.style.fontSize = '1rem';
            dateDiv.style.marginTop = '10px';
            dateDiv.style.color = '#666';
            dateDiv.textContent = `Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`;
            clone.querySelector('.header').appendChild(dateDiv);
            
            // Configure PDF options
            const opt = {
                margin: [10, 10],
                filename: 'tournament-progress.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };
            
            // Create a temporary div for the clone
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.appendChild(clone);
            document.body.appendChild(tempDiv);
            
            // Generate PDF
            html2pdf().set(opt).from(clone).save()
                .then(() => {
                    // Clean up
                    document.body.removeChild(tempDiv);
                    showSystemMessage('PDF generated successfully!');
                })
                .catch(err => {
                    console.error('PDF generation error:', err);
                    showSystemMessage('Error generating PDF. Please try again.');
                });
        }

        function markAllComplete() {
            if (!isAdminMode) {
                showSystemMessage('Only admin can mark milestones complete. Please enable admin mode first.');
                return;
            }
            
            const milestoneFilter = document.getElementById('milestoneFilter').value;
            if (!milestoneFilter) {
                showSystemMessage('Please select a milestone to mark as complete.');
                return;
            }

            const milestone = milestones.find(m => m.id.toString() === milestoneFilter);
            if (milestone && confirm(`Mark all tasks in "${milestone.title}" as complete?`)) {
                milestone.sections.forEach(section => {
                    section.tasks.forEach((task, taskIndex) => {
                        const taskId = `${milestone.id}-${section.title}-${taskIndex}`;
                        setTaskCompletion(taskId, true, 'Admin Bulk Complete');
                    });
                });
                renderTasks();
                updateStats();
                showSystemMessage(`All tasks in "${milestone.title}" marked as complete!`);
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Event listeners
        document.getElementById('memberFilter').addEventListener('change', renderTasks);
        document.getElementById('milestoneFilter').addEventListener('change', renderTasks);
        document.getElementById('statusFilter').addEventListener('change', renderTasks);

        // Modal event listeners
        document.getElementById('completionName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmCompletion();
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const completionModal = document.getElementById('completionModal');
            const memberModal = document.getElementById('memberModal');
            const systemModal = document.getElementById('systemModal');
            const modalOverlay = document.getElementById('modalOverlay');
            
            if (event.target === completionModal) {
                closeCompletionModal();
            } else if (event.target === modalOverlay && !systemModal.style.display === 'block') {
                closeMemberModal();
            }
        }

        // Add these new functions at the start of your script section
        function showSystemMessage(message) {
            closeAllModals(); // Close any open modals first
            
            const modal = document.getElementById('systemModal');
            const messageDiv = modal.querySelector('.message');
            const overlay = document.getElementById('modalOverlay');
            
            messageDiv.textContent = message;
            modal.style.display = 'block';
            overlay.style.display = 'block';
        }

        function closeSystemModal() {
            const modal = document.getElementById('systemModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.style.display = 'none';
            overlay.style.display = 'none';
        }

        // Add this function to your JavaScript
        async function updateVersionTag() {
            try {
                // Add cache-busting parameter to prevent caching of version.json
                const response = await fetch('version.json?' + new Date().getTime());
                if (response.ok) {
                    const data = await response.json();
                    const versionDisplay = `Version ${data.version}`;
                    const dateDisplay = data.date ? ` (${data.date})` : '';
                    const commitDisplay = data.commit && data.commit !== 'initial' ? ` - ${data.commit}` : '';
                    document.getElementById('versionTag').textContent = versionDisplay + dateDisplay + commitDisplay;
                    return;
                } else {
                    throw new Error('Failed to load version.json');
                }
            } catch (error) {
                console.error('Error loading version:', error);
                // Fallback to build timestamp if version.json fails
                const buildDate = new Date().toLocaleDateString();
                document.getElementById('versionTag').textContent = `Version 1.0.0 (${buildDate})`;
            }
        }

        // Add version check on page load and visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                updateVersionTag();
            }
        });

        // Update version every minute when the page is visible
        setInterval(() => {
            if (!document.hidden) {
                updateVersionTag();
            }
        }, 60000);

        function showConfirmationDialog(message, checkbox, callback) {
            closeAllModals(); // Close any open modals first
            
            const modal = document.getElementById('confirmationModal');
            const overlay = document.getElementById('modalOverlay');
            const messageDiv = modal.querySelector('.message');
            
            messageDiv.textContent = message;
            modal.style.display = 'block';
            overlay.style.display = 'block';
            
            confirmationCallback = callback;
            confirmationCheckbox = checkbox;
        }

        function handleConfirmationResponse(confirmed) {
            const modal = document.getElementById('confirmationModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.style.display = 'none';
            overlay.style.display = 'none';
            
            if (confirmationCallback) {
                confirmationCallback(confirmed);
            }
            
            confirmationCallback = null;
            confirmationCheckbox = null;
        }

        function toggleAdminMode() {
            const passwordInput = document.getElementById('adminPassword');
            const adminBtn = document.getElementById('adminBtn');
            if (!isAdminMode) {
                if (passwordInput.value === adminPassword) {
                    isAdminMode = true;
                    adminBtn.textContent = 'Disable Admin';
                    adminBtn.className = 'btn btn-secondary';
                    passwordInput.style.display = 'none';
                    showSystemMessage('Admin mode enabled!');
                } else {
                    showSystemMessage('Incorrect password. Please try again.');
                    passwordInput.value = '';
                    return;
                }
            } else {
                isAdminMode = false;
                adminBtn.textContent = 'Enable Admin';
                adminBtn.className = 'btn btn-primary';
                passwordInput.style.display = 'block';
                passwordInput.value = '';
                showSystemMessage('Admin mode disabled.');
            }
            renderTasks();
            updateStats();
        }

        // Ensure updateStats is called after rendering tasks
        const originalRenderTasks = renderTasks;
        renderTasks = function() {
            originalRenderTasks();
            updateStats();
        };

        function updateStats() {
            let total = 0, completed = 0, overdue = 0;
            const now = new Date();
            milestones.forEach(milestone => {
                milestone.sections.forEach(section => {
                    section.tasks.forEach((task, taskIndex) => {
                        const taskId = `${milestone.id}-${section.title}-${taskIndex}`;
                        const completion = getTaskCompletion(taskId);
                        total++;
                        if (completion.isCompleted) {
                            completed++;
                        } else if (new Date(milestone.deadline) < now) {
                            overdue++;
                        }
                    });
                });
            });
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = total - completed;
            document.getElementById('overdueTasks').textContent = overdue;
        }

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>